<!DOCTYPE html>
<html lang="en">
	<head>

		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width">
		<title>IFD Requests</title>
		<script src="https://get.mavo.io/mavo.js"></script>
		<link rel="stylesheet" href="https://get.mavo.io/mavo.css">
		<scropt src="https://dmitrysharabin.github.io/mavo-firebase-firestore/src/mavo-firebase-firestore.js"></scropt>
		<script defer src="ifd.js"></script>
		<style>
			.logged-out .show-logged-in {
				display: none;
			}
			.logged-in .show-logged-out {
				display: none;
			}
			.r-label {
				padding-left 1em;
				padding-right 1em;
			}
			.played {
				text-decoration: line-through;
			}
			#session-header {
				max-width: 30em;
			}
			#session-select {
				float: right;
			}
			body {
				display: flex;
				min-height: 98vh;
				flex-direction: column;
			}
			main {
				flex: 1;
			}
		</style>
	</head>
	<body class="logged-out">

		<main>

			<div style="display:none" mv-app="dances" mv-storage="none" mv-source="./ifd.csv" mv-format="csv">
				<datalist id="dancelist">
					<option mv-multiple mv-group property="dance" value="[label]"></option>
				</datalist>
			</div>
			
			<div mv-app="util" mv-storage="none"
				 mv-firebase="auth realtime"
				 mv-plugins="firebase-firestore"
				 mv-autosave="0"
				 mv-bar="status login logout"
				 mv-source="https://mavo-cd7c3.firebaseio.com/ifdr-user/0"
				 mv-storage="none"
				 mv-firebase-key="AIzaSyC0PxY82lVLTLv80ZU1z5sz1azoYZits0I"
				 >
				<meta id="signal" property="signal">
				<meta property="userStorage" mv-value="if(uid(util.signal),'https://mavo-cd7c3.firebaseio.com/ifdr-user/'&uid(util.signal),'none')">
			</div>
			
			<section
				mv-app="ifdr"
				class="mavo-user" 
				mv-firebase="auth realtime"
				mv-bar="none"
				mv-plugins="firebase-firestore"
				mv-autosave="0"
				mv-bar="status login logout"
				mv-storage="[util.userStorage]"
				mv-firebase-key="AIzaSyC0PxY82lVLTLv80ZU1z5sz1azoYZits0I"
				>
				<div style="display:none">
					[setSignal('signal')]
					[watchRequests(mysid)]
					[watchSessions()]
				</div>

				<details><summary>Click for instructions</summary>
					<ol>
                        <li>Log in at the top</li>
                        <li>Choose a session</li>
                        <li>Click the Check in button to let the Markid know you're dancing</li>
                        <li>Request dances</li>
                        <li>Check out if you step away, so they don't play your requests at the wrong time.  Your requests will be saved, but they won't show in the request list until you check in again.</li>
					</ol>
				</details>

				<meta property="sessions" mv-value="getSessions(util.signal)">
				<div id="session-header">
					<select id="session-select" property="mysid" name="session" width="60">
						<option value="" selected hidden disabled>Choose session</option>
						<option mv-group mv-multiple value="[id]" mv-value="sessions">[name]</option>
					</select>
					<h2>Session</h2>
				</div>
				<meta property="sessionStorage"
					  mv-value="if(mysid&&uid(util.signal),'https://mavo-cd7c3.firebaseio.com/ifdr-session/' & mysid,'none')">
				<meta property="active" mv-value="mysid and checkedIn">
				<meta property="lastActive">
				<meta property="name">
				
				<div class="show-logged-out">
					Log in to make requests.
				</div>

				<div class="show-logged-in">
					
					<div mv-if="not(mysid) and not(checkedIn)">
						Choose a session and check in to make requests.
					</div>
					<div>
						<meta property="checkedIn" mv-value="false" mv-storage="none">
						<div mv-if="!checkedIn">Click <button mv-action="set(checkedIn,true),set(lastActive,+$now),set(name,username())">Check In</button> to make requests</div>
						<div mv-if="checkedIn">Click <button mv-action="set(checkedIn,false),set(lastActive,0)">Check Out</button> to suspend your requests while you're away</div>
					</div>
					<div mv-if="active">
						<h2>My Requests</h2>

						Choose a dance:
						<div style="display:inline-block;">
							<input list="dancelist" property="selection" mv-storage="none">
							<button mv-action="if(selection,add(group(label: selection, timestamp: +$now),ifdr.pick)); set(lastActive,+$now); set(selection,'')">request</button>
							<button mv-action="set(selection,'')">clear</button>
						</div>
						<div>If it's <span class="played">crossed out</span>, it's been played.</div>
						<div class="[if(played,'played','unplayed')]" mv-multiple property="pick" mv-initial-items="0">
							<button mv-action="delete($this)">X</button> <span property="label"></span> <meta property="timestamp"> <meta property="played" mv-value="has(label,playlist.played.label)">
						</div>
					</div>
			</section>

			<section mv-app="showRequests" mv-storage="none" mv-bar="none">
				<h2>Everyone's Requests</h2>

				<table class="request-table">
					<tr>
						<th></th>
						<th></th>
						<th>Dance</th>
						<th>Count</th>
					</tr>
					<tr class="request [if(played,'played','unplayed')]" mv-multiple property="requests" mv-value="markPlayed(getRequests(util.signal),playlist.played,util.signal)">
						<td><button mv-if="ifdr.active and not(mine) and not(played)" mv-action="add(group(label: label, timestamp: +$now),ifdr.pick); set(ifdr.lastActive,+$now)">request</button>
						<td>
						<td><span class="r-label" property="label"></span>
						<td><span class="r-count" property="count"></span>
							<meta property="played">
							<meta property="mine" mv-value="has(label,ifdr.pick.label)">
					</tr>
				</table>
			</section>

			<div
				mv-app="playlist"
				mv-firebase="realtime"
				mv-plugins="firebase-firestore"
				mv-storage="none"
				mv-bar="none"
				mv-source="[ifdr.sessionStorage]"
				mv-siurce="https://mavo-cd7c3.firebaseio.com/ifdr-session/test"
				mv-siurce="https://mavo-cd7c3.firebaseio.com/ifdr-session/[url(session)]"
				mv-firebase-key="AIzaSyC0PxY82lVLTLv80ZU1z5sz1azoYZits0I"
				>
				<h2>Played</h2>
				<div class="playlist" mv-multiple property="played" mv-initial-items="0">
					<div property="label"></div> 
				</div>
			</div>
		</main>
		<footer>IFD Request app created by David Karger.  <a href="mailto:karger@mit.edu">Please send feedback.</a></footer>
	</body>
</html>
