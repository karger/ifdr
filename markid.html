<!DOCTYPE html>
<html lang="en">
	<head>

		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width">
		<title>IFD Markid</title>
		<script src="//get.mavo.io/stable/mavo.es5.js"></script>
		<link rel="stylesheet" href="//get.mavo.io/stable/mavo.css">
		<script src="ifd.js"></script>
		<style>
			.logged-out .show-logged-in {
				display: none;
			}
			.logged-in .show-logged-out {
				display: none;
			}
			.dance-table {
				margin-left: 1em;
			}
			.my-play {
				font-weight: bold;
			}
			.dance-table td {
				padding-right: 1em;
			}
			.played {
				text-decoration: line-through;
			}
			#heading {
				width: 100%;
			}
			.playlist {
				margin-left: 1em;
			}
			.playlist button {
				margin-right: 1em;
			}
			.users {
				margin-left: 1em;
			}
			.users button {
				margin-right: 1em;
			}
			.mv-status span {
				display: none;
			}
			.inactive {
				text-decoration: line-through;
			}
			#session-select {
				float: right;
			}
			.r-names:not(:last-child):after {
				content: ", "
			}
			#clear {
				margin-top: 2em;
			}
			.hidePlayed .played {
				display: none;
			}
			body {
				display: flex;
				min-height: 98vh;
				flex-direction: column;
				margin-top: 0;
			}
			main {
				flex: 1;
 				display:flex;
				flex-flow: row wrap;
				justify-content: space-between;
				align-items: flex-start;
				align-content: flex-start;
			}
			footer {
				padding-top: 3em;
				font-size: small;
			}
			section {
				margin-right: 2em
			}
		</style>
	</head>
	<body>

		<!--login/utility-->
		<div mv-app="util" mv-storage="none"
			 mv-firebase="auth realtime"
			 mv-plugins="firebase-firestore"
			 mv-bar="status login logout"
			 mv-source="https://mavo-cd7c3.firebaseio.com/ifdr-user/0"
			 mv-firebase-key="AIzaSyC0PxY82lVLTLv80ZU1z5sz1azoYZits0I"
			 >
			<meta id="signal" property="signal">
			<meta property="uid" mv-value="getUid(signal)">
			<div property="me" mv-value="getProfile(signal)">
				<meta property="uid"> <meta property="name">
			</div>
			<meta property="sessionStore" mv-value="if(url('session'),'https://mavo-cd7c3.firebaseio.com/ifdr-session/' & url('session'),'none')">
		</div>

		<!--dance list-->
		<div hidden mv-app="dances" mv-storage="none" mv-source="[if(url('session'),'ifd.csv','none')]" mv-format="csv">
			<datalist id="dancelist">
				<option mv-multiple mv-group property="dance" value="[label]"></option>
			</datalist>
		</div>

		<main>
			<div mv-app="requests" mv-storage="none" mv-bar="none"
				 mv-plugins="sort" style="display:contents">
				<!--header-->
				<section id="heading">
					<meta property="sessions" mv-value="getSessions(util.signal)">
					<meta property="mysid" mv-value="url('session')">

					<details><summary>Click for instructions</summary>
						<ol>
							<li>Choose your session using the dropdown and click <button>Go to Session</button></li>
							<li>Log in at the top</li>
							<li>Look over the requests</li>
							<li>Click <button>play</button> next to each request you play or queue up, so it will be marked played.</li>
							<li>If you click play by mistake, just click the <button>X</button> in the list of <b>Played</b> dances</li>
							<li>There is a checkbox to let you include the dances you've already played in the same list, and another to see who requested each dance.
							<li>Below that is a list of folks currently checked in to your session.  If you know someone has left, you can chexk them out by clicking the <button>X</button>.  Or check them back in by clicking the <button>+</button>.</li>
							<li>There is a checkbox to let you manage markidim (add new ones who will be able to run this playlist app) and also to show requests by individual.
						</ol>
					</details>
					

					<form id="session-select" method="get" action="markid.html">
						<select property="nextSession" name="session" width="60">
							<option value="" selected disabled>Choose a session</option>
							<option mv-group mv-multiple value="[id]" mv-value="getSessions(util.signal)" selected="[id=url('session')]">[name]</option>
						</select>
						<input type="submit" value="Go to Session">
					</form>
					<div mv-if="not(mysid)">Choose a session to begin</div>

					<div mv-if="mysid">
						<h2>[condense(sessions where id=mysid).name]</h2>
					</div>
				</section>

				<!--Requests-->
				<section mv-if="mysid">
					<div>
						<div style="float:right">
							<div> <label><input type="checkbox"property="showPlayed" mv-storage="none" >Include played</label></div>
							<div><label><input type="checkbox" property="showNames" mv-storage="none">Show who</label></div>
							<div><label><input type="checkbox" property="showTimes" mv-storage="none">Show times</label></div>
							<div><label><input type="checkbox" mv-storage="none" property="notify" mv-storage="none">Notify</label><span hidden>[watchNotify(notify)]</span></div>
						</div>
						<h2>Requests</h2>
					</div>

					<meta property="thisMinute" mv-value="round($now/60000)*60000">
					<table class="dance-table [if(showPlayed, 'showPlayed', 'hidePlayed')]">
						<tr>
							<th></th>
							<th>Dance</th>
							<th>Count</th>
							<th mv-if="showTimes">Age</th>
							<th mv-if="showNames">Who</th>
						</tr>

						<tr>
							<td><button mv-action="add(group(label: playSelection, timestamp: +$now, markid: util.me.name),session.played); set(playSelection,'')">play</button>
							<td><input list="dancelist" placeholder="Enter Dance" property="playSelection" mv-storage="none">
						</tr>

						<tr class="request [if(played,'played','unplayed')]" mv-multiple property="requests" mv-value="sort(mergePicks(session.users where active,util.signal),'-count','-timestamp')">
							<td><button mv-if="not(played)" title="mark played"
										mv-action="add(group(label: label, timestamp: +$now, markid: util.me.name),session.played)">play</button>
							<td><span class="dance-label" property="label"></span>
							<td><span property="count"></span>
							<td mv-if="showTimes"><meta property="timestamp"><span class="r-time">[duration(thisMinute-timestamp)]</span>
							<td mv-if="showNames"><span class="r-names" mv-multiple property="names"></span>
							<td><meta property="played" mv-value="lookup(session.playedIndex,label)">
						</tr>
					</table>
				</section>
			</div>

			<div mv-if="requests.mysid"
				 mv-app="session" mv-bar="none"
				 mv-firebase="auth realtime"
				 mv-plugins="firebase-firestore"
				 mv-autosave="5"
				 mv-storage="[util.sessionStore]"
				 mv-firebase-key="AIzaSyC0PxY82lVLTLv80ZU1z5sz1azoYZits0I"
				 style="display:contents"
				 >
				<div style="display:none">
					[setSignal('sig'&'nal')]
					[watchUsers(requests.mysid,duration)]
					[watchSessions(duration)]
					<meta mv-multiple property="owner">
					<div mv-multiple property="markidim" mv-initial-items="0">
						<meta property="uid"> <meta property="name">
					</div>
					<meta mv-multiple property="markidUids" mv-value="markidim.uid" mv-storage="inherit">

					<div property="pushOutTimes" mv-multiple mv-initial-items="0">
						<meta property="uid"></meta>
						<meta property="time" type="number"></meta>
					</div>
					<meta property="pushOutIndex" mv-value="makeIndex(pushOutTimes,'uid')">
				</div>

				<!--Playlist-->
				<section style="clear: both">
					<div style="float:right; vertical-align: top">
						<div><label><input type="checkbox" mv-storage="none" property="showMarkid">Show Markid</label></div>
					</div>


					<h2>Accepted</h2>

					<table class="dance-table">
						<tr><th></th><th>Dance</th><th mv-if="showMarkid">Assigned markid</th><th>Notes</th></tr>
						<tr class="playlist [if(myPlay and showMarkid,'my-play')]" mv-multiple property="played" mv-initial-items="0">
							<td><button mv-action="delete($this)">X</button></td>
							<td><span class="dance-label" property="label"></span>
								<meta property="timestamp">
								<meta property="myPlay" mv-value="markid=util.me.name"></td>
							<td mv-if="showMarkid">
								<input list="markidList"
									   property="markid"></td>
							<td><span property="notes" mv-mode="edit"></span></td>
						</tr>
					</table>
					
					<datalist id="markidList">
						<option mv-multiple property="ownerChoice" mv-attribute="value" mv-value="markidim.name" value="[ownerChoice]"></option>
					</datalist>

					<meta property="playedIndex" mv-value="makeIndex(played.label)">

					<button id="clear" mv-action="delete(played)">Clear playlist</button>
				</section>

				<!--Folks-->
				<section>
					<div style="clear:both">
						<div style="float:right; vertical-align: top">
							<div><label><input type="checkbox" mv-storage="none" property="addMarkid"> Manage markidim</label></div>
							<div><label><input type="checkbox" mv-storage="none" property="showRequests"> Show requests</label></div>
							Activity: <select property="duration" mv-default="6*24*60*60*1000">
								<option value="[30*60*1000]">past half hour</option>
								<option value="[1*60*60*1000]">past hour</option>
								<option value="[4*60*60*1000]">past 4 hours</option>
								<option value="[24*60*60*1000]">past day</option>
								<option selected value="[6*24*60*60*1000]">past 6 days</option>
								<option value="[30*24*60*60*1000]">past month</option>
								<option value="[365*24*60*60*1000]">past year</option>
								<option value="[10*365*24*60*60*1000]">all</option>
								<!--option value="">specific date</option-->
							</select>
							<!-- mv-if="!durationChoice" input type="datetime-local" property="beginCustom" mv-storage="none" -->
							<!-- mv-value="durationChoice || if(beginCustom, $startup-beginCustom, 4*60*60*1000)"-->
						</div>

						<h2>Folks</h2>
						<div style="clear:both">Click <button>X</button> to check out people who've left, or <button>+</button> to check them back in.</div>

						<div property="users" class="users" mv-multiple class="[if(active,'','inactive')]"
							 mv-value="sort(getUsers(util.signal),'-checkInTime')">
							<meta property="uid">
							<meta property="checkInTime">
							<meta property="pushOutTime" mv-value="lookup(lookup(pushOutIndex,uid),'time') or -1">
							<meta property="active" mv-value="checkInTime > (pushOutTime or 0)">
							<button mv-action="add(uid,owner),add(group(uid:uid,name:name),markidim)" mv-if="addMarkid and not(uid in owner)">Make Markid</button>
							<button mv-action="delete(owner where owner=uid),delete(markidim where markidim.uid=uid)" mv-if="addMarkid and (uid in owner)">Remove Markid</button>
							<button mv-if="not(active)" title="Check in" 
									mv-action="set(pushOutTimes, pushOutTimes where pushOutTimes.uid != uid), Mavo.all.session.expressions.update()">+</button>
							<button mv-if="active" title="Check out"
									mv-action="set(pushOutTimes, pushOutTimes where pushOutTimes.uid != uid),add(group(uid: uid, time: +$now),pushOutTimes)">X</button>
							<span property="name"></span><span mv-if="showRequests">: [picks.label]</span>
						</div>

						<div property="toPushOut" mv-multiple mv-value="users where checkInTime > 0" mv-storage="none">
							<meta property="myuid" mv-value="uid">
							<div property="container">
								<meta property="uid" mv-value="myuid">
								<meta property="time" mv-value="+$now">
							</div>
						</div>
						<button mv-action="set(pushOutTimes,toPushOut.container)">Check All Out</button>
						<meta property="userIndex" mv-value="makeIndex(users,'uid')">
				</section>

		</main>

		<footer>Created by David Karger.  <a href="mailto:karger@mit.edu">Please send feedback.</a></footer>


	</body>
</html>
